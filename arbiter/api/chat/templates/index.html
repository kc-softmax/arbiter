<html>
  <head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script>
      const ROOM_JOIN = "room_join";
      const USER_JOIN = "user_join";
      const USER_LEAVE = "user_leave";
      const ERROR = "error";
      const MESSAGE = "message";

      let current_users = [];

      $(document).ready(function () {
        if (typeof WebSocket != "undefined") {
          $("#ask").show();
        } else {
          $("#error").show();
        }

        // join on enter
        $("#ask input").keydown(function (event) {
          if (event.keyCode == 13) {
            $("#ask a").click();
          }
        });

        // join on click
        $("#ask a").click(function () {
          join($("#ask input").val());
          $("#ask").hide();
          $("#channel").show();
          $("input#message").focus();
        });

        function join(name) {
          // var host = window.location.host.split(":")[0];
          var ws = new WebSocket(
            `ws://127.0.0.1:8000/chat/jay/ws?token=${name}`
          );
          var container = $("div#msgs");
          ws.onopen = function () {
            ws.send("ready");
          };
          ws.onclose = function (evt) {
            if (evt.code === 3000) {
              alert("유효하지 않은 토큰입니다.");
            }
          };

          ws.onmessage = function (evt) {
            console.log(evt);
            var obj = JSON.parse(evt.data);
            if (typeof obj != "object") return;

            var action = obj["action"];
            var data = obj["data"];

            // custom
            if (action == ROOM_JOIN) {
              $("#room_id").text(data["room_id"]);

              // 대화 불러오기
              messages = data["messages"];
              if (messages.length > 0) {
                messages.forEach((msg_obj) => {
                  var msg = container
                    .find("li." + "message" + ":first")
                    .clone();
                  msg.find(".user").text(msg_obj["user"]);
                  msg.find(".message").text(": " + msg_obj["message"]);
                  msg.find(".time").text(msg_obj["time"]);

                  container.find("ul").append(msg.show());
                  container.scrollTop(container.find("ul").innerHeight());
                });
              }

              // 유저 목록
              current_users = data["users"];
              $("#users").text(`${current_users}`);
              return;
            }

            var struct = container.find("li." + action + ":first");
            if (struct.length < 1) {
              console.log("Could not handle: " + evt.data);
              return;
            }

            // custom
            if (action == USER_JOIN || action == USER_LEAVE) {
              let changed_user = data["user"];
              if (action == USER_JOIN && changed_user != name) {
                current_users.push(changed_user);
              } else if (action === USER_LEAVE) {
                current_users = current_users.filter(
                  (user) => user != changed_user
                );
              }
              $("#users").text(`${current_users}`);
              let user_dom = struct.clone();
              user_dom.find(".user").text(`${changed_user}`);
              container.find("ul").append(user_dom.show());
              return;
            }

            if (action == MESSAGE) {
              var msg = struct.clone();
              var matches;
              if ((matches = data["message"].match(/^\s*[\/\\]me\s(.*)/))) {
                msg.find(".user").text(data["user"] + " " + matches[1]);
                msg.find(".user").css("font-weight", "bold");
              } else {
                msg.find(".user").text(data["user"]);
                msg.find(".message").text(": " + data["message"]);
              }
            } else if (action == "control") {
              msg.find(".user").text(data["user"]);
              msg.find(".message").text(data["message"]);
              msg.addClass("control");
            }
            msg.find(".time").text(data["time"]);

            if (data["user"] == name) msg.find(".user").addClass("self");
            container.find("ul").append(msg.show());
            container.scrollTop(container.find("ul").innerHeight());
          };

          $("#channel form").submit(function (event) {
            event.preventDefault();
            var input = $(this).find(":input");
            var msg = input.val();
            if (msg) {
              ws.send(
                JSON.stringify({
                  action: "message",
                  data: {
                    message: msg,
                  },
                })
              );
            }
            input.val("");
          });
        }
      });
    </script>
    <style type="text/css" media="screen">
      * {
        font-family: Georgia;
      }
      a {
        color: #000;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      div.bordered {
        margin: 0 auto;
        margin-top: 100px;
        width: 600px;
        padding: 20px;
        text-align: center;
        border: 10px solid #ddd;
        -webkit-border-radius: 20px;
      }
      #error {
        background-color: #ba0000;
        color: #fff;
        font-weight: bold;
      }
      #ask {
        font-size: 20pt;
      }
      #ask input {
        font-size: 20pt;
        padding: 10px;
        margin: 0 10px;
      }
      #ask span.join {
        padding: 10px;
        background-color: #ddd;
        -webkit-border-radius: 10px;
      }
      #channel {
        margin-top: 100px;
        height: 480px;
        position: relative;
      }
      #channel div#descr {
        position: absolute;
        left: -10px;
        top: -190px;
        font-size: 13px;
        text-align: left;
        line-height: 20px;
        padding: 5px;
        width: 630px;
      }
      div#msgs {
        overflow-y: scroll;
        height: 400px;
      }
      div#msgs ul {
        list-style: none;
        padding: 0;
        margin: 0;
        text-align: left;
      }
      div#msgs li {
        line-height: 20px;
      }
      div#msgs li span.user {
        color: #ff9900;
      }
      div#msgs li span.user.self {
        color: #aa2211;
      }
      div#msgs li span.time {
        float: right;
        margin-right: 5px;
        color: #aaa;
        font-family: "Courier New";
        font-size: 12px;
      }
      div#msgs li.control {
        text-align: center;
      }
      div#msgs li.control span.message {
        color: #aaa;
      }
      div#input {
        text-align: left;
        margin-top: 20px;
      }
      div#input #message {
        width: 600px;
        border: 5px solid #bbb;
        -webkit-border-radius: 3px;
        font-size: 30pt;
      }
    </style>
  </head>
  <body>
    <div id="error" class="bordered" style="display: none">
      This browser has no native WebSocket support.<br />
      Use a WebKit nightly or Google Chrome.
    </div>
    <div id="ask" class="bordered" style="display: none">
      Name: <input type="text" id="name" />
      <a href="#"><span class="join">Join!</span></a>
    </div>
    <div id="channel" class="bordered" style="display: none">
      <div id="descr" class="bordered">
        <strong>ROOM ID:</strong>
        <span id="room_id"></span>
        <br />
        <strong>USERS:</strong>
        <span id="users"></span>
      </div>
      <div id="msgs">
        <ul>
          <li class="message" style="display: none">
            <span class="user"></span><span class="message"></span>
            <span class="time"></span>
          </li>
          <li class="user_join" style="display: none">
            <span class="user"></span><span>님이 입장하였습니다.</span>
          </li>
          <li class="user_leave" style="display: none">
            <span class="user"></span><span>님이 퇴장하였습니다.</span>
          </li>
        </ul>
      </div>
      <div id="input">
        <form><input type="text" id="message" /></form>
      </div>
    </div>
  </body>
</html>
